<!DOCTYPE html>
<html>
<head>
    <title>Secure WebRTC</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' wss://your-domain.com:8765;">
    <style>
        body { font-family: sans-serif; }
        video { border: 1px solid black; width: 480px; height: 360px; background: #222; }
        .container { display: flex; gap: 20px; }
        .video-box { display: flex; flex-direction: column; gap: 10px; }
        #status { font-weight: bold; }
    </style>
</head>
<body>

    <h1>WebRTC + Python WebSocket サーバー</h1>
    <p>ステータス: <span id="status">未接続</span></p>

    <div class="container">
        <div class="video-box">
            <h2>自分の映像</h2>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
        <div class="video-box">
            <h2>相手の映像</h2>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>

    <hr>

    <div class="control-box">
        <button id="startButton">1. カメラを開始</button>
        <button id="callButton" disabled>2. 通話を開始</button>
        <button id="hangupButton" disabled>通話を終了</button>
    </div>

    <script>
        class SecureWebRTCClient {
            constructor() {
                this.localStream = null;
                this.peerConnection = null;
                this.ws = null;
                this.token = null;
                this.roomId = null;
                this.userId = null;
                
                // セキュアな設定
                this.peerConfig = {
                    iceServers: [
                        {
                            urls: 'turn:your-turn-server.com:3478',
                            username: 'username',
                            credential: 'password'
                        }
                    ],
                    iceTransportPolicy: 'relay', // TURNサーバーを強制使用
                };
            }

            async connect(token, roomId, userId) {
                this.token = token;
                this.roomId = roomId;
                this.userId = userId;

                // セキュアなWebSocket接続
                this.ws = new WebSocket('wss://221.118.128.239:8000');
                
                this.ws.onopen = async () => {
                    // 認証情報の送信
                    await this.authenticate();
                };

                this.setupWebSocketHandlers();
            }

            async authenticate() {
                const authMessage = {
                    type: 'auth',
                    token: this.token,
                    room_id: this.roomId,
                    user_id: this.userId
                };
                this.ws.send(JSON.stringify(authMessage));
            }

            async startCall() {
                try {
                    // メディアストリームの取得時に制約を設定
                    const constraints = {
                        video: {
                            width: { max: 1280 },
                            height: { max: 720 },
                            frameRate: { max: 30 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    };
                    
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // セキュアなPeerConnection作成
                    await this.createSecurePeerConnection();
                    
                } catch (e) {
                    console.error('Error starting call:', e);
                    throw e;
                }
            }

            async createSecurePeerConnection() {
                this.peerConnection = new RTCPeerConnection(this.peerConfig);
                
                // セキュリティ設定の検証
                if (!this.validatePeerConnection()) {
                    throw new Error('Insecure PeerConnection configuration');
                }

                // 各種イベントハンドラの設定
                this.setupPeerConnectionHandlers();
                
                // ローカルストリームの追加
                this.localStream.getTracks().forEach(track => {
                    this.peerConnection.addTrack(track, this.localStream);
                });
            }

            validatePeerConnection() {
                // PeerConnectionの設定を検証
                return (
                    this.peerConnection.configuration.iceTransportPolicy === 'relay' &&
                    this.peerConnection.configuration.iceServers &&
                    this.peerConnection.configuration.iceServers.length > 0
                );
            }

            setupPeerConnectionHandlers() {
                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.sendSignalingMessage({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            sender: this.userId,
                            room_id: this.roomId
                        });
                    }
                };

                // 通信の暗号化状態を監視
                this.peerConnection.onconnectionstatechange = () => {
                    if (this.peerConnection.connectionState === 'connected') {
                        // DTLS-SRTPの暗号化を確認
                        const senders = this.peerConnection.getSenders();
                        senders.forEach(sender => {
                            if (sender.transport) {
                                console.log('DTLS state:', sender.transport.state);
                            }
                        });
                    }
                };
            }

            sendSignalingMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }

            cleanup() {
                if (this.peerConnection) {
                    this.peerConnection.close();
                }
                if (this.ws) {
                    this.ws.close();
                }
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                }
            }
        }

        // 使用例
        const client = new SecureWebRTCClient();
        
        // ログイン後に接続を開始
        async function startSecureConnection() {
            try {
                await client.connect(
                    'your-secure-token',
                    'room-123',
                    'user-456'
                );
                await client.startCall();
            } catch (e) {
                console.error('Connection failed:', e);
            }
        }

        // クリーンアップ
        window.onbeforeunload = () => {
            client.cleanup();
        };
    </script>
</body>
</html>
